---
###############################################################################
#
# Ansible remediation role for profile xccdf_org.ssgproject.content_profile_C2S
# Profile Title:  C2S for Red Hat Enterprise Linux 7
# Profile Description:  This profile demonstrates compliance against the
#U.S. Government Commercial Cloud Services (C2S) baseline.
#
#This baseline was inspired by the Center for Internet Security
#(CIS) Red Hat Enterprise Linux 7 Benchmark, v2.1.1 - 01-31-2017.
#
#For the SCAP Security Guide project to remain in compliance with
#CIS' terms and conditions, specifically Restrictions(8), note
#there is no representation or claim that the C2S profile will
#ensure a system is in compliance or consistency with the CIS
#baseline.
#
#
# Benchmark ID:  xccdf_org.ssgproject.content_benchmark_RHEL-7
# Benchmark Version:  0.1.36
#
# XCCDF Version:  1.2
#
# This file was generated by OpenSCAP 1.2.15 using:
# 	$ oscap xccdf generate fix --profile xccdf_org.ssgproject.content_profile_C2S --template urn:xccdf:fix:script:ansible sds.xml 
#
# This script is generated from an OpenSCAP profile without preliminary evaluation.
# It attempts to fix every selected rule, even if the system is already compliant.
#
###############################################################################


 - hosts: localhost # set required host
   connection: local
   tasks:
    - name: "Read permission of GPG key directory"
      stat:
        path: /etc/pki/rpm-gpg/
      register: gpg_key_directory_permission
      check_mode: no
      tags:
        - ensure_redhat_gpgkey_installed
        - high_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-26957-1
        - NIST-800-53-CM-5(3)
        - NIST-800-53-SI-7
        - NIST-800-53-MA-1(b)
        - NIST-800-171-3.4.8
        - PCI-DSS-Req-6.2
        - CJIS-5.10.4.1
        - DISA-366
    
    # It should fail if it doesn't find any fingerprints in file - maybe file was not parsed well.
    
    - name: Read signatures in GPG key
      shell: gpg --with-fingerprint '/etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release' | grep 'Key fingerprint =' | tr -s ' ' | sed 's;.*= ;;g'
      changed_when: False
      register: gpg_fingerprints
      check_mode: no
      tags:
        - ensure_redhat_gpgkey_installed
        - high_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-26957-1
        - NIST-800-53-CM-5(3)
        - NIST-800-53-SI-7
        - NIST-800-53-MA-1(b)
        - NIST-800-171-3.4.8
        - PCI-DSS-Req-6.2
        - CJIS-5.10.4.1
        - DISA-366
    
    - name: Set Fact - Valid fingerprints
      set_fact:
         gpg_valid_fingerprints: ("567E 347A D004 4ADE 55BA 8A5F 199E 2F91 FD43 1D51" "43A6 E49C 4A38 F4BE 9ABF 2A53 4568 9C88 2FA6 58E0")
      tags:
        - ensure_redhat_gpgkey_installed
        - high_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-26957-1
        - NIST-800-53-CM-5(3)
        - NIST-800-53-SI-7
        - NIST-800-53-MA-1(b)
        - NIST-800-171-3.4.8
        - PCI-DSS-Req-6.2
        - CJIS-5.10.4.1
        - DISA-366
    
    - name: Import CentOS GPG key
      rpm_key:
        state: present
        key: /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
      when:
        (gpg_key_directory_permission.stat.mode <= '0755')
        and (( gpg_fingerprints.stdout_lines | difference(gpg_valid_fingerprints)) | length == 0)
        and (gpg_fingerprints.stdout_lines | length > 0)
        and (ansible_distribution == "CentOS")
      tags:
        - ensure_redhat_gpgkey_installed
        - high_severity
        - restrict_strategy
        - medium_complexity
        - medium_disruption
        - CCE-26957-1
        - NIST-800-53-CM-5(3)
        - NIST-800-53-SI-7
        - NIST-800-53-MA-1(b)
        - NIST-800-171-3.4.8
        - PCI-DSS-Req-6.2
        - CJIS-5.10.4.1
        - DISA-366
    
    - name: "Check existence of yum on Fedora"
      stat:
        path: /etc/yum.conf
      register: yum_config_file
      check_mode: no
      when: ansible_distribution == "Fedora"
    
    # Old versions of Fedora use yum
    
    - name: "Ensure GPG check is globally activated (yum)"
      ini_file:
        dest: "{{item}}"
        section: main
        option: gpgcheck
        value: 1
        create: False
      with_items: "/etc/yum.conf"
      when: ansible_distribution == "CentOS" or yum_config_file.stat.exists
      tags:
        - ensure_gpgcheck_globally_activated
        - high_severity
        - unknown_strategy
        - low_complexity
        - medium_disruption
        - CCE-26989-4
        - NIST-800-53-CM-5(3)
        - NIST-800-53-SI-7
        - NIST-800-53-MA-1(b)
        - NIST-800-171-3.4.8
        - PCI-DSS-Req-6.2
        - CJIS-5.10.4.1
        - DISA-SRG-OS-000366-GPOS-00153
        - DISA-STIG-RHEL-07-020050

    - name: "Ensure gpgcheck Enabled for local packages"
      ini_file:
        dest: "{{ item }}"
        section: main
        option: localpkg_gpgcheck
        value: 1
        create: False
      with_items: "/etc/yum.conf"
      when: ansible_distribution == "CentOS" or yum_config_file.stat.exists

    - name: "Ensure gpgcheck Enabled for Repository Metadata"
      ini_file:
        dest: "{{ item }}"
        section: main
        option: repo_gpgcheck
        value: 1
        create: False
      with_items: "/etc/yum.conf"
      when: ansible_distribution == "CentOS" or yum_config_file.stat.exists

    
    - name: "Ensure YUM removes previous package versions"
      ini_file:
        dest: "{{ item }}"
        section: main
        option: clean_requirements_on_remove
        value: 1
        create: False
      with_items: "/etc/yum.conf"
      when: ansible_distribution == "CentOS" or yum_config_file.stat.exists

    
    - name: "Ensure GPG check is globally activated (dnf)"
      ini_file:
        dest: "{{item}}"
        section: main
        option: gpgcheck
        value: 1
        create: False
      with_items: "/etc/dnf/dnf.conf"
      when: ansible_distribution == "Fedora"
      tags:
        - ensure_gpgcheck_globally_activated
        - high_severity
        - unknown_strategy
        - low_complexity
        - medium_disruption
        - CCE-26989-4
        - NIST-800-53-CM-5(3)
        - NIST-800-53-SI-7
        - NIST-800-53-MA-1(b)
        - NIST-800-171-3.4.8
        - PCI-DSS-Req-6.2
        - CJIS-5.10.4.1
        - DISA-SRG-OS-000366-GPOS-00153
        - DISA-STIG-RHEL-07-020050
    
    
    - name: disable prelinking
      lineinfile:
        create: True
        path: /etc/sysconfig/prelink
        regexp: '^PRELINKING='
        line: 'PRELINKING=no'
      tags:
        - disable_prelink
        - low_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27078-5
        - NIST-800-53-CM-6(d)
        - NIST-800-53-CM-6(3)
        - NIST-800-53-SC-28
        - NIST-800-53-SI-7
        - NIST-800-171-3.13.11
        - PCI-DSS-Req-11.5
        - CJIS-5.10.1.3
    
    - name: "Ensure aide is installed"
      package:
        name="{{item}}"
        state=present
      with_items:
        - aide
      tags:
        - package_aide_installed
        - medium_severity
        - enable_strategy
        - low_complexity
        - low_disruption
        - CCE-27096-7
        - NIST-800-53-CM-3(d)
        - NIST-800-53-CM-3(e)
        - NIST-800-53-CM-6(d)
        - NIST-800-53-CM-6(3)
        - NIST-800-53-SC-28
        - NIST-800-53-SI-7
        - PCI-DSS-Req-11.5
        - CJIS-5.10.1.3

    - name: "Configure periodic Execution of AIDE"
      cron:
        name: Run AIDE
        minute: "05"
        hour: "4"
        job: '/usr/sbin/aide --check | /bin/mail -s "$(hostname) - AIDE Integrity Check" root@localhost'

    - name: "Configure AIDE"
      copy:
        src: files/aide.conf
        dest: /etc/aide.conf

    - name: "Install dracut-fips" 
      package:
        name: dracut-fips
        state: installed

    - name: "Run dracut -f"
      shell: "dracut -f"

    - name: "Enable FIPS mode in grub2"
      shell: 'sed -i "s/\(GRUB_CMDLINE_LINUX=\)\"\(.*\)\"/\1\"\2 fips=1\"/" /etc/default/grub'
      
    - name: Check for efi
      stat: 
        path: /sys/firmware/efi
      register: efi_enabled

    - name: Register boot with EFI
      shell: "df /boot/efi | tail -1 | awk '{print $1 }'"
      register: boot_dir
      when: efi_enabled.stat.exists

    - name: Register boot without EFI
      shell: "df /boot | tail -1 | awk '{ print $1 }'"
      register: boot_dir
      when: efi_enabled.stat.exists == 'false'

    - name: "Correct kernel commandline for each installed kernel"
      shell: '/sbin/grubby --update-kernel=ALL --args="boot={{ item }} fips=1"'
      with_items: "{{ boot_dir }}"
    
    - name: "get back device associated to mountpoint"
      shell: mount | grep ' /tmp ' |cut -d ' ' -f 1
      register: device_name
      check_mode: no
      tags:
        - mount_option_tmp_nodev
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80149-8
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "get back device previous mount option"
      shell: mount | grep ' /tmp ' | sed -re 's:.*\((.*)\):\1:'
      register: device_cur_mountoption
      check_mode: no
      tags:
        - mount_option_tmp_nodev
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80149-8
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "get back device fstype"
      shell: mount | grep ' /tmp ' | cut -d ' ' -f 5
      register: device_fstype
      check_mode: no
      tags:
        - mount_option_tmp_nodev
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80149-8
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "Ensure permission nodev are set on /tmp"
      mount:
        path: "/tmp"
        src: "{{device_name.stdout}}"
        opts: "{{device_cur_mountoption.stdout}},nodev"
        state: "mounted"
        fstype: "{{device_fstype.stdout}}"
      tags:
        - mount_option_tmp_nodev
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80149-8
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    
    - name: "get back device associated to mountpoint"
      shell: mount | grep ' /tmp ' |cut -d ' ' -f 1
      register: device_name
      check_mode: no
      tags:
        - mount_option_tmp_noexec
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80150-6
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "get back device previous mount option"
      shell: mount | grep ' /tmp ' | sed -re 's:.*\((.*)\):\1:'
      register: device_cur_mountoption
      check_mode: no
      tags:
        - mount_option_tmp_noexec
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80150-6
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "get back device fstype"
      shell: mount | grep ' /tmp ' | cut -d ' ' -f 5
      register: device_fstype
      check_mode: no
      tags:
        - mount_option_tmp_noexec
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80150-6
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "Ensure permission noexec are set on /tmp"
      mount:
        path: "/tmp"
        src: "{{device_name.stdout}}"
        opts: "{{device_cur_mountoption.stdout}},noexec"
        state: "mounted"
        fstype: "{{device_fstype.stdout}}"
      tags:
        - mount_option_tmp_noexec
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80150-6
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    
    - name: "get back device associated to mountpoint"
      shell: mount | grep ' /tmp ' |cut -d ' ' -f 1
      register: device_name
      check_mode: no
      tags:
        - mount_option_tmp_nosuid
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80151-4
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "get back device previous mount option"
      shell: mount | grep ' /tmp ' | sed -re 's:.*\((.*)\):\1:'
      register: device_cur_mountoption
      check_mode: no
      tags:
        - mount_option_tmp_nosuid
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80151-4
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "get back device fstype"
      shell: mount | grep ' /tmp ' | cut -d ' ' -f 5
      register: device_fstype
      check_mode: no
      tags:
        - mount_option_tmp_nosuid
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80151-4
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "Ensure permission nosuid are set on /tmp"
      mount:
        path: "/tmp"
        src: "{{device_name.stdout}}"
        opts: "{{device_cur_mountoption.stdout}},nosuid"
        state: "mounted"
        fstype: "{{device_fstype.stdout}}"
      tags:
        - mount_option_tmp_nosuid
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80151-4
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    
    - name: "get back device associated to mountpoint"
      shell: mount | grep ' /dev/shm ' |cut -d ' ' -f 1
      register: device_name
      check_mode: no
      tags:
        - mount_option_dev_shm_nodev
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80152-2
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "get back device previous mount option"
      shell: mount | grep ' /dev/shm ' | sed -re 's:.*\((.*)\):\1:'
      register: device_cur_mountoption
      check_mode: no
      tags:
        - mount_option_dev_shm_nodev
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80152-2
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "get back device fstype"
      shell: mount | grep ' /dev/shm ' | cut -d ' ' -f 5
      register: device_fstype
      check_mode: no
      tags:
        - mount_option_dev_shm_nodev
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80152-2
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "Ensure permission nodev are set on /dev/shm"
      mount:
        path: "/dev/shm"
        src: "{{device_name.stdout}}"
        opts: "{{device_cur_mountoption.stdout}},nodev"
        state: "mounted"
        fstype: "{{device_fstype.stdout}}"
      tags:
        - mount_option_dev_shm_nodev
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80152-2
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    
    - name: "get back device associated to mountpoint"
      shell: mount | grep ' /dev/shm ' |cut -d ' ' -f 1
      register: device_name
      check_mode: no
      tags:
        - mount_option_dev_shm_noexec
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80153-0
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "get back device previous mount option"
      shell: mount | grep ' /dev/shm ' | sed -re 's:.*\((.*)\):\1:'
      register: device_cur_mountoption
      check_mode: no
      tags:
        - mount_option_dev_shm_noexec
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80153-0
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "get back device fstype"
      shell: mount | grep ' /dev/shm ' | cut -d ' ' -f 5
      register: device_fstype
      check_mode: no
      tags:
        - mount_option_dev_shm_noexec
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80153-0
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "Ensure permission noexec are set on /dev/shm"
      mount:
        path: "/dev/shm"
        src: "{{device_name.stdout}}"
        opts: "{{device_cur_mountoption.stdout}},noexec"
        state: "mounted"
        fstype: "{{device_fstype.stdout}}"
      tags:
        - mount_option_dev_shm_noexec
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80153-0
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    
    - name: "get back device associated to mountpoint"
      shell: mount | grep ' /dev/shm ' |cut -d ' ' -f 1
      register: device_name
      check_mode: no
      tags:
        - mount_option_dev_shm_nosuid
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80154-8
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "get back device previous mount option"
      shell: mount | grep ' /dev/shm ' | sed -re 's:.*\((.*)\):\1:'
      register: device_cur_mountoption
      check_mode: no
      tags:
        - mount_option_dev_shm_nosuid
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80154-8
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "get back device fstype"
      shell: mount | grep ' /dev/shm ' | cut -d ' ' -f 5
      register: device_fstype
      check_mode: no
      tags:
        - mount_option_dev_shm_nosuid
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80154-8
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    - name: "Ensure permission nosuid are set on /dev/shm"
      mount:
        path: "/dev/shm"
        src: "{{device_name.stdout}}"
        opts: "{{device_cur_mountoption.stdout}},nosuid"
        state: "mounted"
        fstype: "{{device_fstype.stdout}}"
      tags:
        - mount_option_dev_shm_nosuid
        - low_severity
        - configure_strategy
        - low_complexity
        - high_disruption
        - CCE-80154-8
        - NIST-800-53-CM-7
        - NIST-800-53-MP-2
    
    
    - name: "Ensure kernel module 'cramfs' is disabled"
      lineinfile:
        create=yes
        dest="/etc/modprobe.d/{{item}}.conf"
        regexp="{{item}}"
        line="install {{item}} /bin/true"
      with_items:
        - cramfs
      tags:
        - kernel_module_cramfs_disabled
        - low_severity
        - disable_strategy
        - low_complexity
        - medium_disruption
        - CCE-80137-3
        - NIST-800-53-CM-7
        - NIST-800-171-3.4.6
    
    
    - name: "Ensure kernel module 'freevxfs' is disabled"
      lineinfile:
        create=yes
        dest="/etc/modprobe.d/{{item}}.conf"
        regexp="{{item}}"
        line="install {{item}} /bin/true"
      with_items:
        - freevxfs
      tags:
        - kernel_module_freevxfs_disabled
        - low_severity
        - disable_strategy
        - low_complexity
        - medium_disruption
        - CCE-80138-1
        - NIST-800-53-CM-7
        - NIST-800-171-3.4.6
    
    
    - name: "Ensure kernel module 'jffs2' is disabled"
      lineinfile:
        create=yes
        dest="/etc/modprobe.d/{{item}}.conf"
        regexp="{{item}}"
        line="install {{item}} /bin/true"
      with_items:
        - jffs2
      tags:
        - kernel_module_jffs2_disabled
        - low_severity
        - disable_strategy
        - low_complexity
        - medium_disruption
        - CCE-80139-9
        - NIST-800-53-CM-7
        - NIST-800-171-3.4.6
    
    
    - name: "Ensure kernel module 'hfs' is disabled"
      lineinfile:
        create=yes
        dest="/etc/modprobe.d/{{item}}.conf"
        regexp="{{item}}"
        line="install {{item}} /bin/true"
      with_items:
        - hfs
      tags:
        - kernel_module_hfs_disabled
        - low_severity
        - disable_strategy
        - low_complexity
        - medium_disruption
        - CCE-80140-7
        - NIST-800-53-CM-7
        - NIST-800-171-3.4.6
    
    
    - name: "Ensure kernel module 'hfsplus' is disabled"
      lineinfile:
        create=yes
        dest="/etc/modprobe.d/{{item}}.conf"
        regexp="{{item}}"
        line="install {{item}} /bin/true"
      with_items:
        - hfsplus
      tags:
        - kernel_module_hfsplus_disabled
        - low_severity
        - disable_strategy
        - low_complexity
        - medium_disruption
        - CCE-80141-5
        - NIST-800-53-CM-7
        - NIST-800-171-3.4.6
    
    
    - name: "Ensure kernel module 'squashfs' is disabled"
      lineinfile:
        create=yes
        dest="/etc/modprobe.d/{{item}}.conf"
        regexp="{{item}}"
        line="install {{item}} /bin/true"
      with_items:
        - squashfs
      tags:
        - kernel_module_squashfs_disabled
        - low_severity
        - disable_strategy
        - low_complexity
        - medium_disruption
        - CCE-80142-3
        - NIST-800-53-CM-7
        - NIST-800-171-3.4.6
    
    
    - name: "Ensure kernel module 'udf' is disabled"
      lineinfile:
        create=yes
        dest="/etc/modprobe.d/{{item}}.conf"
        regexp="{{item}}"
        line="install {{item}} /bin/true"
      with_items:
        - udf
      tags:
        - kernel_module_udf_disabled
        - low_severity
        - disable_strategy
        - low_complexity
        - medium_disruption
        - CCE-80143-1
        - NIST-800-53-CM-7
        - NIST-800-171-3.4.6

    - name: Ensure kernel module 'usb-storage' is disabled
      lineinfile:
        create=yes
        dest="/etc/modprobe.d/{{item}}.conf"
        regexp="{{item}}"
        line="install {{item}} /bin/true"
      with_items:
        - usb-storage
    
    - name: "Prevent Log In to Accounts With Empty Password"
      replace:
        dest: /etc/pam.d/system-auth
        regexp: 'nullok\s*'
        replace: ''

    - name: Ensure sysctl fs.suid_dumpable is set to 0
      sysctl:
        name: fs.suid_dumpable
        value: 0
        state: present
        reload: yes
      tags:
        - sysctl_fs_suid_dumpable
        - low_severity
        - disable_strategy
        - low_complexity
        - medium_disruption
        - CCE-26900-1
        - NIST-800-53-SI-11
    
    
    - name: Ensure sysctl kernel.randomize_va_space is set to 2
      sysctl:
        name: kernel.randomize_va_space
        value: 2
        state: present
        reload: yes
      tags:
        - sysctl_kernel_randomize_va_space
        - medium_severity
        - disable_strategy
        - low_complexity
        - medium_disruption
        - CCE-27127-0
        - NIST-800-53-SC-30(2)
        - NIST-800-171-3.1.7
    
    
    - name: Ensure SELinux Not Disabled in /etc/default/grub
      replace:
        dest: /etc/default/grub
        regexp: selinux=0
      tags:
        - enable_selinux_bootloader
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-26961-3
        - NIST-800-53-AC-3
        - NIST-800-53-AC-3(3)
        - NIST-800-53-AC-3(4)
        - NIST-800-53-AC-4
        - NIST-800-53-AC-6
        - NIST-800-53-AU-9
        - NIST-800-53-SI-6(a)
        - NIST-800-171-3.1.2
        - NIST-800-171-3.7.2
    
    - name: "Ensure SELinux State is Enforcing"
      selinux:
        state: enforcing
        policy: targeted
      tags:
        - selinux_state
        - high_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27334-2
        - NIST-800-53-AC-3
        - NIST-800-53-AC-3(3)
        - NIST-800-53-AC-3(4)
        - NIST-800-53-AC-4
        - NIST-800-53-AC-6
        - NIST-800-53-AU-9
        - NIST-800-53-SI-6(a)
        - NIST-800-171-3.1.2
        - NIST-800-171-3.7.2
        - DISA-SRG-OS-000445-GPOS-00199
        - DISA-STIG-RHEL-07-020210
    
    - name: "Direct root Logins Not Allowed"
      shell: echo > /etc/securetty
      tags:
        - no_direct_root_logins
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27294-8
        - NIST-800-53-IA-2(1)
        - NIST-800-171-3.1.1
        - NIST-800-171-3.1.6
    
    - name: "Disable POST password expiration"
      lineinfile:
        create=yes
        dest="/etc/default/useradd"
        regexp="^INACTIVE"
        line="INACTIVE=1"

    - name: Set Password minimum age
      lineinfile:
        create: yes
        dest: /etc/login.defs
        regexp: ^#?PASS_MIN_DAYS
        line: PASS_MIN_DAYS 1
    
    - name: Set Password Maximum Age
      lineinfile:
          create: yes
          dest: /etc/login.defs
          regexp: ^#?PASS_MAX_DAYS
          line: PASS_MAX_DAYS 90
      tags:
        - accounts_maximum_age_login_defs
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27051-2
        - NIST-800-53-IA-5(f)
        - NIST-800-53-IA-5(g)
        - NIST-800-53-IA-5(1)(d)
        - NIST-800-171-3.5.6
        - PCI-DSS-Req-8.2.4
        - CJIS-5.6.2.1
        - DISA-STIG-RHEL-07-010250
    
    - name: "Ensure kernel module 'dccp' is disabled"
      lineinfile:
        create=yes
        dest="/etc/modprobe.d/{{item}}.conf"
        regexp="{{item}}"
        line="install {{item}} /bin/true"
      with_items:
        - dccp
      tags:
        - kernel_module_dccp_disabled
        - medium_severity
        - disable_strategy
        - low_complexity
        - medium_disruption
        - CCE-26828-4
        - NIST-800-53-CM-7
        - NIST-800-171-3.4.6
        - CJIS-5.10.1

    - name: Set Password Retry Prompts Permitted per-session
      template:
        src: templates/pwquality.conf.j2
        dest: /etc/security/pwquality.conf

    - name: Configure system-auth
      copy:
        src: files/system-auth
        dest: /etc/pam.d/system-auth-ac

    - name: Configure password-auth
      copy:
        src: files/password-auth
        dest: /etc/pam.d/password-auth-ac

    - name: Remove old files if they exist
      file:
        path: "/etc/pam.d/{{ item }}"
        state: absent
      with_items:
        - "password-auth"
        - "system-auth"

    - name: Create links
      file:
        src: /etc/pam.d/{{ item }}-ac
        dest: /etc/pam.d/{{ item }}
        state: link
      with_items:
        - "password-auth"
        - "system-auth"

    - name: Ensure home directories are created for new users
      lineinfile:
        path: /etc/login.defs
        line: "CREATE_HOME yes"
        regexp: "^CREATE_HOME"

    - name: Set interactive session timeout
      lineinfile:
        path: /etc/profile
        line: "TMOUT=600"
        regexp: "^TMOUT"

    - name: Limit the number of concurrent login sessions allowed per user
      lineinfile:
        path: /etc/security/limits.conf
        line: "* hard maxlogins 10"
        regexp: "^\\* hard maxlogins"

    - name: Ensure the logon failure delay is set correctly in login.defs
      lineinfile:
        path: /etc/login.defs
        line: "FAIL_DELAY 4"
        regexp: "^FAIL_DELAY"

    - name: Install the screen package
      package:
        name: screen
        state: installed
    
    - name: Disable ctrlaltdel reboot activation
      systemd:
        name: "ctrl-alt-del.target"
        masked: yes

    - name: Login banner
      copy:
        dest: /etc/issue
        src: files/issue

    - name: sysctl kernel settings
      blockinfile:
        path: /etc/sysctl.conf
        block: |
          net.ipv4.conf.default.send_redirects = 0
          net.ipv4.conf.all.send_redirects = 0
          net.ipv4.ip_forward = 0
          net.ipv4.conf.all.accept_redirects = 0
          net.ipv4.conf.default.accept_redirects = 0
          net.ipv4.icmp_echo_ignore_broadcasts = 1
          net.ipv6.conf.all.accept_source_route = 0
      register: sysctl_settings
      
    - name: Reload sysctl
      shell: "sysctl -p /etc/sysctl.conf"
      when: sysctl_settings.changed

    - name: Set default firewalld zone for incoming packets
      lineinfile:
        path: /etc/firewalld/firewalld.conf
        line: "DefaultZone=drop"
        regexp: ^DefaultZone

    - name: Configure auditd space_left action on low disk space
      lineinfile:
        path: /etc/audit/auditd.conf
        line: "space_left_action = email"
        regexp: ^space_left_action

    - name: Configure audit rules
      copy:
        dest: /etc/audit/rules.d/audit.rules
        src: files/auditd

    - name: Disable kdump service
      service:
        name: kdump
        state: stopped
        enabled: False
      failed_when: False

    - name: "Ensure kernel module 'sctp' is disabled"
      lineinfile:
        create=yes
        dest="/etc/modprobe.d/{{item}}.conf"
        regexp="{{item}}"
        line="install {{item}} /bin/true"
      with_items:
        - sctp
      tags:
        - kernel_module_sctp_disabled
        - medium_severity
        - disable_strategy
        - low_complexity
        - medium_disruption
        - CCE-27106-4
        - NIST-800-53-CM-7
        - NIST-800-171-3.4.6
        - CJIS-5.10.1
    
    
    - name: "Ensure rsyslog is installed"
      package:
        name="{{item}}"
        state=present
      with_items:
        - rsyslog
      tags:
        - package_rsyslog_installed
        - medium_severity
        - enable_strategy
        - low_complexity
        - low_disruption
        - CCE-80187-8
        - NIST-800-53-AU-9(2)
    
    
    - name: "Enable service rsyslog"
      service:
        name="{{item}}"
        enabled="yes"
        state="started"
      with_items:
        - rsyslog
      tags:
        - service_rsyslog_enabled
        - medium_severity
        - enable_strategy
        - low_complexity
        - low_disruption
        - CCE-80188-6
        - NIST-800-53-AU-4(1)
        - NIST-800-53-AU-12
    
    
    
    - name: "Set rsyslog remote loghost to logcollector"
      lineinfile:
        dest: /etc/rsyslog.conf
        regexp: "^\\*\\.\\*"
        line: "*.* @@logcollector"
      tags:
        - rsyslog_remote_loghost
        - low_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27343-3
        - NIST-800-53-AU-3(2)
        - NIST-800-53-AU-4(1)
        - NIST-800-53-AU-9
        - DISA-SRG-OS-000480-GPOS-00227
        - DISA-STIG-RHEL-07-031000
    
    
    - name: "Enable service auditd"
      service:
        name="{{item}}"
        enabled="yes"
        state="started"
      with_items:
        - auditd
      tags:
        - service_auditd_enabled
        - high_severity
        - enable_strategy
        - low_complexity
        - low_disruption
        - CCE-27407-6
        - NIST-800-53-AU-3
        - NIST-800-53-AC-17(1)
        - NIST-800-53-AU-1(b)
        - NIST-800-53-AU-10
        - NIST-800-53-AU-12(a)
        - NIST-800-53-AU-12(c)
        - NIST-800-53-AU-14(1)
        - NIST-800-53-IR-5
        - NIST-800-171-3.3.1
        - NIST-800-171-3.3.2
        - NIST-800-171-3.3.6
        - PCI-DSS-Req-10
        - CJIS-5.4.1.1
        - DISA-SRG-OS-000038-GPOS-00016
        - DISA-SRG-OS-000039-GPOS-00017
        - DISA-SRG-OS-000042-GPOS-00021
        - DISA-SRG-OS-000254-GPOS-00095
        - DISA-SRG-OS-000255-GPOS-00096
        - DISA-STIG-RHEL-07-030000
    
    
    - name: "Enable Auditing for Processes Which Start Prior to the Audit Daemon"
      shell: /sbin/grubby --update-kernel=ALL --args="audit=1"
      tags:
        - bootloader_audit_argument
        - medium_severity
        - restrict_strategy
        - low_complexity
        - low_disruption
        - CCE-27212-0
        - NIST-800-53-AC-17(1)
        - NIST-800-53-AU-14(1)
        - NIST-800-53-AU-1(b)
        - NIST-800-53-AU-2(a)
        - NIST-800-53-AU-2(c)
        - NIST-800-53-AU-2(d)
        - NIST-800-53-AU-10
        - NIST-800-53-IR-5
        - NIST-800-171-3.3.1
        - PCI-DSS-Req-10.3
        - CJIS-5.4.1.1
    
    - name: "Enable service crond"
      service:
        name="{{item}}"
        enabled="yes"
        state="started"
      with_items:
        - crond
      tags:
        - service_crond_enabled
        - medium_severity
        - enable_strategy
        - low_complexity
        - low_disruption
        - CCE-27323-5
        - NIST-800-53-CM-7
    
    - name: Configure sshd
      copy:
        src: files/sshd_config
        dest: /etc/ssh/sshd_config
    
